<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org"
       xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
       layout:decorate="layout/main">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<th:block layout:fragment="content">

    <img th:src="@{/img/logo.jpg}" alt="logo" style="width: 64px;" />

    <div class="container">

        <!-- th:object 可以定义一个对象，*{} 可直接访问其成员属性，二者需同时出现，表单输出很有用！！！ -->
        <ul th:object="${refer}">
            <li th:text="*{name}"></li>
            <li th:text="*{version + ' 正式版'}"></li>
            <li th:text="*{copyright}"></li>
            <li th:utext="*{name} + ' This is an <em>'+ *{version} +'</em> text. <b>'+ *{copyright} +'</b>'"></li>
        </ul>

        <!-- utext 可以输出一段 HTML -->
        <div th:utext="${'This is an <em>HTML</em> text. <b>Enjoy yourself!</b>'}"></div>

        <a class="btn btn-success" href="#" data-toggle="modal" data-target="#add-user">添加用户</a>

        <table class="table table-striped table-bordered table-hover" style="margin-top: 15px;">
            <thead>
            <tr>
                <th class="text-center">#</th>
                <th class="text-center">用户名</th>
                <th class="text-center">密码</th>
                <th class="text-center">手机号</th>
                <th class="text-center">邮箱</th>
                <th class="text-center">创建日期</th>
                <th class="text-center">操作</th>
            </tr>
            <tbody>

            <th:block th:if="${#lists.isEmpty(users) == false}">
                <tr th:each="user,stat : ${users}">
                    <td class="text-center" th:text="${stat.index +'-'+ user.id }"></td>
                    <td class="text-center" th:text="${user.username}"></td>
                    <td class="text-center" th:text="${user.password}"></td>
                    <td class="text-center" th:text="${user.mobile}"></td>
                    <td class="text-center" th:text="${user.email}"></td>
                    <td class="text-center" th:text="${user.created_at}"></td>
                    <td class="text-center">
                        <a class="btn btn-xs btn-primary" th:href="@{'/user-edit?id='+ ${user.id}}">编辑</a>
                        <a class="btn btn-xs btn-danger" href="#" role="row-delete" th:data-id="${user.id}">删除</a>
                    </td>
                </tr>
                <tr>
                    <td class="text-center" colspan="7">
                        共 <th:block th:text="${#arrays.length(users)}"></th:block> 条数据
                    </td>
                </tr>
            </th:block>

            <th:block th:if="${#lists.isEmpty(users) == true}">
                <tr>
                    <td class="text-center" colspan="7">没有数据！</td>
                </tr>
            </th:block>

            </tbody>
            </thead>
        </table>

    </div>

    <div id="add-user" class="modal fade" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">添加用户</h4>
                </div>
                <div class="modal-body">

                    <form class="form-horizontal" role="add-user-form">

                        <div class="form-group">
                            <label for="username" class="col-sm-2 control-label">用户名</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="username" name="username"
                                       placeholder="请填写用户名" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="password" class="col-sm-2 control-label">登录密码</label>
                            <div class="col-sm-10">
                                <input type="password" class="form-control" id="password" name="password"
                                       placeholder="请填写登录密码" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="mobile" class="col-sm-2 control-label">手机号</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="mobile" name="mobile"
                                       placeholder="请填写手机号" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="email" class="col-sm-2 control-label">邮箱</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="email" name="email"
                                       placeholder="请填写邮箱" />
                            </div>
                        </div>

                    </form>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" role="add-user-reset" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" role="add-user-submit">添加</button>
                </div>
            </div>
        </div>
    </div>

</th:block>

<th:block layout:fragment="extendScript">
    <script type="text/javascript">
        $(function () {

            // 行编辑和删除
            (function () {

                var $delete = $('[role="row-delete"]');

                $delete.on('click', function (e) {
                    e.preventDefault();
                    if (!confirm('确定删除当前用户？删除后不可恢复！')) return;

                    var $this = $(e.target);
                    var id = $this.data('id');

                    $.ajax({
                        method: 'delete',
                        url: '/api/user/delete',
                        data: {
                            id: id
                        },
                        success: function (res) {
                            res = $.extend(true, {
                                code: '000000',
                                msg: 'Success'
                            }, res);

                            if (res.code !== '000000') {
                                alert(res.msg || '删除失败');
                                return;
                            }

                            window.location.reload();

                        }
                    });

                });

            })();

            // 添加用户
            (function () {
                'use strict';

                var $submit = $('[role="add-user-submit"]');
                var $reset = $('[role="add-user-reset"]');
                var $form = $('[role="add-user-form"]');

                function newRow(data) {
                    window.location.reload();
                }

                $submit.on('click', function () {
                    var data = $form.serialize();
                    console.log(data);

                    $.ajax({
                        method: 'post',
                        url: '/api/user/add',
                        data: data,
                        success: function (res) {
                            res = $.extend(true, {
                                code: '000000',
                                msg: 'Success'
                            }, res);

                            if (res.code !== '000000') {
                                alert(res.msg || '添加失败');
                                return;
                            }

                            // 添加新行
                            newRow(res.data);
                        }
                    });

                });


            })();

        });
    </script>
</th:block>

</body>
</html>